#!/usr/bin/env bash

# Script to update and upgrade Arch Linux, including AUR packages and maintenance

# Exit on any error
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if script is run with sudo
if [[ $EUID -eq 0 ]]; then
    echo -e "${RED}Error: This script should not be run as root. Use a user with sudo privileges.${NC}"
    exit 1
fi

echo -e "${BLUE}

/////////////////////////////////////////////////////////////////////"
echo "//////////////////////     SYSTEM UPDATE     ////////////////////////"
echo "/////////////////////////////////////////////////////////////////////"


# Check for internet connectivity
echo -e "${BLUE}
> Checking internet connectivity...

    ${NC}"
if ! ping -c 1 archlinux.org &> /dev/null; then
    echo -e "${RED}Error: No internet connection. Please check your network and try again.${NC}"
    exit 1
fi

# Check for Arch news (requires informant or manual check)
echo -e "${BLUE}
> Checking for Arch Linux news...${NC}"

if command -v informant >/dev/null 2>&1; then
    if ! sudo informant check; then
        echo -e "${RED}Unread Arch news detected.${NC}"
        echo "Please read carefully the news..."
        sudo informant read
        echo
        read -p "Have you read and understood the news? (y/N): " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            echo "Aborting update. Please read the news carefully before proceeding."
            exit 1
        fi
    fi
fi
# Update Arch keyring first to avoid signature issues
echo -e "${BLUE}
> Updating Arch Linux keyring...

     ${NC}"
sudo pacman -Syy --noconfirm archlinux-keyring blackarch-keyring

# Perform full system update
echo -e "${BLUE}
> Performing full system update:${NC}"
echo -e "${BLUE}
> Update through official repositories...
	
	${NC}"
sudo pacman -Syu --noconfirm

# Update AUR packages if yay or paru is installed
if command -v yay >/dev/null 2>&1; then
    echo -e "${BLUE}
> Updating AUR packages with yay...
	
	${NC}"
    yay -Syu --noconfirm
elif command -v paru >/dev/null 2>&1; then
    echo -e "${BLUE}
> Updating AUR packages with paru...
	
	${NC}"
    paru -Syu --noconfirm
else
    echo -e "${RED}No AUR helper (yay or paru) found. Skipping AUR updates.${NC}"
fi

# Clean package cache to save space
echo -e "${BLUE}
> Cleaning package cache...
	
	${NC}"
sudo pacman -Sc --noconfirm
paccache -r -k 1

# Check for orphaned packages and remove them
echo -e "${BLUE}
> Checking for orphaned packages...${NC}"
if [[ -n $(pacman -Qdtq) ]]; then
    sudo pacman -Rns $(pacman -Qdtq) --noconfirm
else
    echo "No orphaned packages found."
fi

# Check for broken dependencies
echo -e "${BLUE}
> Checking for broken dependencies...
	
	${NC}"
sudo pacman -Dk || {
    echo -e "${RED}Broken dependencies found. Attempting to fix...${NC}"
    sudo pacman -Syyu --noconfirm
}

# Check if reboot is needed (e.g., kernel update)
if [[ -f /var/run/reboot-required ]]; then
    echo -e "${GREEN}System update complete. A reboot is required.${NC}"
    read -p "Reboot now? (y/N): " reboot
    if [[ "$reboot" =~ ^[Yy]$ ]]; then
        sudo reboot
    fi
else
    echo -e "${GREEN}System update complete. No reboot required.${NC}"
fi

exit 0
